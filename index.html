<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaveh's Comfort Characters</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/P5qtkxDF/Touya_Icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-teal: #008080;
            --win-gray: #c0c0c0;
            --win-border-light: #ffffff;
            --win-border-dark: #808080;
            --win-border-black: #000000;
            --win-blue: #000080;
            --win-blue-light: #1084d0;
            --win-gray-dark: #707070;
            --sel-blue: #000080;
        }

        body {
            background-color: var(--bg-teal);
            font-family: 'Tahoma', sans-serif;
            overflow: hidden;
            height: 100vh;
            user-select: none;
            margin: 0;
            font-size: 11px;
            touch-action: none;
        }

        /* WINDOW */
        .window-border {
            box-shadow: inset 1px 1px 0px var(--win-border-light), 
                        inset -1px -1px 0px var(--win-border-dark),
                        1px 1px 0px var(--win-border-black);
            background-color: var(--win-gray);
            border: 1px solid var(--win-border-light);
            border-right-color: var(--win-border-dark);
            border-bottom-color: var(--win-border-dark);
            overflow: hidden;
        }

        .btn-border {
            box-shadow: inset 1px 1px 0px var(--win-border-light), 
                        inset -1px -1px 0px var(--win-border-dark),
                        1px 1px 0px var(--win-border-black);
            background-color: var(--win-gray);
            border: 1px solid var(--win-border-light);
            border-right-color: var(--win-border-dark);
            border-bottom-color: var(--win-border-dark);
            cursor: pointer;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-border:active:not(:disabled) {
            box-shadow: inset 1px 1px 0px var(--win-border-black),
                        inset -1px -1px 0px var(--win-border-light);
            border: 1px solid var(--win-border-dark);
            border-right-color: var(--win-border-light);
            border-bottom-color: var(--win-border-light);
            padding: 1px 0 0 1px;
        }

        .retro-border-inset {
            border: 1px solid var(--win-border-dark);
            border-right-color: var(--win-border-light);
            border-bottom-color: var(--win-border-light);
            box-shadow: inset 1px 1px 0px var(--win-border-black),
                        1px 1px 0px var(--win-border-light);
        }

        .title-bar {
            background: var(--win-gray-dark);
            color: #d0d0d0;
            padding: 2px 3px;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            height: 18px;
            margin: 2px;
            cursor: default;
            flex-shrink: 0;
            touch-action: none;
        }

        .window.active-win .title-bar {
            background: linear-gradient(90deg, var(--win-blue), var(--win-blue-light));
            color: white;
        }

        .win-title-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }

        /* ANIMATION */
        .window {
            position: absolute;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transform-origin: center center;
        }

        .window.animating {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.1), 
                        opacity 0.2s, top 0.2s, left 0.2s, width 0.2s, height 0.2s;
        }

        .window.opening { transform: scale(0.85); opacity: 0; }
        .window.minimized { transform: scale(0.1) translateY(100vh); opacity: 0; pointer-events: none; }
        .window.maximized { top: 0 !important; left: 0 !important; width: 100vw !important; height: calc(100vh - 30px) !important; transform: scale(1) !important; z-index: 9999 !important; }

        /* CD PLAYER UI */
        .cd-display {
            background: #000; color: #ccff00; font-family: 'monospace'; padding: 8px;
            border: 2px solid var(--win-border-dark); box-shadow: inset 2px 2px 0 #000;
            min-width: 170px; text-align: center;
        }

        /* VOLUME SLIDER */
        .volume-container { display: flex; align-items: center; gap: 8px; margin-top: 10px; width: 100%; }
        
        .volume-slider {
            -webkit-appearance: none; 
            flex: 1; 
            height: 2px; 
            background: #000; 
            outline: none; 
            border: 1px solid #fff;
            border-top: none;
            border-left: none;
            position: relative;
        }

        .volume-slider::-webkit-slider-runnable-track {
            height: 4px;
            background: #808080;
            border: 1px solid #000;
            border-right-color: #fff;
            border-bottom-color: #fff;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 20px;
            background: var(--win-gray);
            border: 1px solid #fff;
            border-right-color: #000;
            border-bottom-color: #000;
            box-shadow: inset 1px 1px 0 #dfdfdf;
            cursor: pointer;
            margin-top: -9px; 
            position: relative;
            z-index: 2;
        }

        /* DESKTOP ICON LAYOUT */
        #desktop-grid {
            display: grid;
            grid-auto-flow: column;
            grid-template-rows: repeat(auto-fill, 90px);
            grid-template-columns: repeat(auto-fill, 80px);
            gap: 10px;
            height: calc(100vh - 40px);
            width: fit-content;
            padding: 10px;
            pointer-events: none;
        }

        .desktop-icon {
            width: 75px;
            height: 85px;
            text-align: center;
            cursor: pointer;
            padding: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 5;
            pointer-events: auto;
            touch-action: none;
        }
        .desktop-icon span { color: white; padding: 2px 4px; margin-top: 2px; border: 1px solid transparent; text-shadow: 1px 1px 1px black; pointer-events: none; }
        .desktop-icon.selected span { background-color: var(--sel-blue); border: 1px dotted #ffffff; }

        .taskbar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 30px;
            background-color: var(--win-gray); border-top: 1px solid var(--win-border-light);
            display: flex; align-items: center; padding: 2px; z-index: 99999; box-shadow: inset 1px 1px 0 white;
        }

        .resizer {
            width: 16px; height: 16px; position: absolute; right: 0; bottom: 0;
            cursor: nwse-resize; z-index: 20;
            background: linear-gradient(135deg, transparent 50%, var(--win-border-dark) 50%, var(--win-border-dark) 60%, transparent 60%, transparent 70%, var(--win-border-dark) 70%);
            touch-action: none;
        }

        .hidden { display: none !important; }
        select.retro-select {
            appearance: none; background: white url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10'%3E%3Cpath d='M0 0l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 5px center;
            border: 1px solid var(--win-border-dark); box-shadow: inset 1px 1px 0 var(--win-border-black); padding-right: 20px; font-size: 11px;
        }

        .task-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 4px;
            border: 2px solid;
            border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            background: var(--win-gray);
            height: 22px;
            min-width: 60px;
            max-width: 150px;
            font-size: 11px;
            text-align: left;
            box-shadow: 1px 1px 0 var(--win-border-black);
        }

        .task-btn.active-task {
            border-color: var(--win-border-dark) var(--win-border-light) var(--win-border-light) var(--win-border-dark);
            background: #e0e0e0;
            box-shadow: inset 1px 1px 0 var(--win-border-black);
            font-weight: bold;
        }

        /* LOADING */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid var(--win-blue);
            border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar { width: 16px; height: 16px; }
        ::-webkit-scrollbar-track { background: #dfdfdf; box-shadow: inset 1px 1px 0 #808080, inset -1px -1px 0 #fff; }
        ::-webkit-scrollbar-thumb { background: var(--win-gray); border: 1px solid #fff; border-right-color: #000; border-bottom-color: #000; box-shadow: inset 1px 1px 0 #dfdfdf, 1px 1px 0 #808080; }
        
        ::-webkit-scrollbar-button { 
            background: var(--win-gray); 
            border: 1px solid #fff; 
            border-right-color: #000; 
            border-bottom-color: #000; 
            width: 16px; 
            height: 16px;
            display: block;
            background-repeat: no-repeat;
            background-position: center;
        }

        ::-webkit-scrollbar-button:vertical:start:increment,
        ::-webkit-scrollbar-button:vertical:end:decrement {
            display: none;
        }
        
        ::-webkit-scrollbar-button:vertical:start:decrement {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M4 2L1 6h6z' fill='black'/%3E%3C/svg%3E");
        }
        ::-webkit-scrollbar-button:vertical:end:increment {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M4 6L1 2h6z' fill='black'/%3E%3C/svg%3E");
        }

        ::-webkit-scrollbar-button:active {
            background-color: #dfdfdf;
            box-shadow: inset 1px 1px 0 #000;
            border: 1px solid #808080;
            border-right-color: #fff;
            border-bottom-color: #fff;
        }

        /* IFRAME FIXES */
        .profile-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            display: block;
        }
    </style>
</head>
<body onclick="hideStartMenu()">

    <div id="desktop" class="relative w-full h-full overflow-hidden" onmousedown="deselectAllIcons(event)" ontouchstart="deselectAllIcons(event)">
        <!-- ICONS -->
        <div id="icon-layer" class="absolute inset-0 z-10 pointer-events-none">
            <div id="desktop-grid">
                <div id="icon-computer" class="desktop-icon" onmousedown="handleIconInteraction(event, 'win-mycomputer')" ontouchstart="handleIconInteraction(event, 'win-mycomputer')">
                    <img src="https://i.postimg.cc/Y9VdbLqP/computer_explorer_5.png" class="w-8 h-8 pointer-events-none">
                    <span>My Computer</span>
                </div>
                <div id="icon-about" class="desktop-icon" onmousedown="handleIconInteraction(event, 'win-about')" ontouchstart="handleIconInteraction(event, 'win-about')">
                    <img src="https://i.postimg.cc/WbcnzvDq/notepad_5.png" class="w-8 h-8 pointer-events-none">
                    <span>Readme.txt</span>
                </div>
                <div id="icon-crk" class="desktop-icon" onmousedown="handleIconInteraction(event, 'Cookie Run: Kingdom', true)" ontouchstart="handleIconInteraction(event, 'Cookie Run: Kingdom', true)">
                    <img src="https://i.postimg.cc/K8MgC9rW/Cookie_Run_Kingdom.png" class="w-8 h-8 pointer-events-none">
                    <span>Cookie Run: Kingdom</span>
                </div>
                <div id="icon-hoyo" class="desktop-icon" onmousedown="handleIconInteraction(event, 'Hoyoverse', true)" ontouchstart="handleIconInteraction(event, 'Hoyoverse', true)">
                    <img src="https://i.postimg.cc/7Z2TjBMt/Hoyoverse.png" class="w-8 h-8 pointer-events-none">
                    <span>Hoyoverse</span>
                </div>
                <div id="icon-lcb" class="desktop-icon" onmousedown="handleIconInteraction(event, 'Limbus Company', true)" ontouchstart="handleIconInteraction(event, 'Limbus Company', true)">
                    <img src="https://i.postimg.cc/t4xV8rtB/Limbus_Company.png" class="w-8 h-8 pointer-events-none">
                    <span>Limbus Company</span>
                </div>
                <div id="icon-obm" class="desktop-icon" onmousedown="handleIconInteraction(event, 'Obey Me', true)" ontouchstart="handleIconInteraction(event, 'Obey Me', true)">
                    <img src="https://i.postimg.cc/kgwtG7Wh/MC.png" class="w-8 h-8 pointer-events-none">
                    <span>Obey Me</span>
                </div>
                <div id="icon-pjsk" class="desktop-icon" onmousedown="handleIconInteraction(event, 'Project Sekai', true)" ontouchstart="handleIconInteraction(event, 'Project Sekai', true)">
                    <img src="https://i.postimg.cc/Z5dyXfF7/Project_Sekai.png" class="w-8 h-8 pointer-events-none">
                    <span>Project Sekai</span>
                </div>
                <div id="icon-misc" class="desktop-icon" onmousedown="handleIconInteraction(event, 'MISC', true)" ontouchstart="handleIconInteraction(event, 'MISC', true)">
                    <img src="https://i.postimg.cc/PqS3vFg9/directory_closed_4.png" class="w-8 h-8 pointer-events-none">
                    <span>MISC</span>
                </div>
                <div id="icon-wallpaper" class="desktop-icon" onmousedown="handleIconInteraction(event, 'win-display')" ontouchstart="handleIconInteraction(event, 'win-display')">
                    <img src="https://i.postimg.cc/BQb299x6/display_properties_5.png" class="w-8 h-8 pointer-events-none">
                    <span>Wallpaper</span>
                </div>
                <div id="icon-music" class="desktop-icon" onmousedown="handleIconInteraction(event, 'win-music')" ontouchstart="handleIconInteraction(event, 'win-music')">
                    <img src="https://i.postimg.cc/7PGsb9KY/cd_audio_cd_a_4.png" class="w-8 h-8 pointer-events-none">
                    <span>CD Player</span>
                </div>
            </div>
        </div>

        <!-- CD PLAYER -->
        <div id="win-music" class="window window-border hidden opening animating" style="top: 100px; left: 200px; width: 360px;" onmousedown="focusWin('win-music')">
            <div class="title-bar" onmousedown="dragWindow(event, 'win-music')" ontouchstart="dragWindow(event, 'win-music')">
                <div class="flex items-center gap-1 min-w-0 flex-1">
                    <img src="https://i.postimg.cc/7PGsb9KY/cd_audio_cd_a_4.png" class="w-4 h-4 flex-shrink-0"> 
                    <span class="win-title-text">CD Player</span>
                </div>
                <div class="flex gap-[2px] flex-shrink-0">
                    <button class="btn-border w-4 h-4 text-[10px] pb-1 font-bold" onclick="minimizeWin('win-music')">_</button>
                    <button class="btn-border w-4 h-4 text-[10px] font-bold" onclick="closeWin('win-music')">√ó</button>
                </div>
            </div>
            <div class="p-2 space-y-2 bg-gray-200">
                <div class="flex gap-2">
                    <div class="cd-display">
                        <div id="cd-play-indicator" class="text-[9px] h-3 text-left px-1 opacity-0">PLAYING</div>
                        <div class="text-[20px] font-bold" id="cd-time">[00] 00:00 / 00:00</div>
                        <div id="cd-error" class="text-[9px] text-red-500 h-3 hidden">LOAD ERROR</div>
                        <div id="cd-track-count" class="text-[10px] opacity-50">Track 0/0</div>
                    </div>
                    <div class="grid grid-cols-2 gap-1 flex-1">
                        <button class="btn-border h-6 col-span-2 font-bold" id="play-btn" onclick="playAudio()">‚ñ∂ Play</button>
                        <button class="btn-border h-6" onclick="pauseAudio()">||</button>
                        <button class="btn-border h-6" onclick="stopAudio()">‚ñ†</button>
                        <button class="btn-border h-6" onclick="prevTrack()">‚èÆ</button>
                        <button class="btn-border h-6" onclick="nextTrack()">‚è≠</button>
                    </div>
                </div>

                <div class="grid grid-cols-[50px_1fr] gap-x-2 gap-y-1 items-center text-[11px]">
                    <span><u>A</u>rtist:</span>
                    <div class="retro-border-inset bg-white px-1 h-5 overflow-hidden text-[10px]" id="cd-artist">---</div>
                    <span><u>T</u>itle:</span>
                    <div class="retro-border-inset bg-white px-1 h-5 overflow-hidden text-[10px]" id="cd-title">---</div>
                    <span>Trac<u>k</u>:</span>
                    <select id="cd-track-select" class="retro-select w-full h-5" onchange="changeTrack()">
                    <option value="none">-- Select Track --</option>
                    <option value="song1" data-url="https://raw.githubusercontent.com/Asiandra/comfort-characters/main/Music/Beast-Yeast%208.%20Beacon%20of%20Truth.mp3" data-artist="Cookie Run: Kingdom" data-title="Beast Yeast 8. Beacon of Truth">Beast Yeast 8. Beacon of Truth</option>
                    <option value="song2" data-url="https://raw.githubusercontent.com/Asiandra/comfort-characters/main/Music/Aku%20no%20Taizai%20BGM.mp3" data-artist="Project Sekai" data-title="Aku no Taizai BGM">Aku no Taizai BGM</option>
                    <option value="song3" data-url="https://raw.githubusercontent.com/Asiandra/comfort-characters/main/Music/Bgm_street_sekai.mp3" data-artist="Project Sekai" data-title="Street Sekai BGM">Street Sekai BGM</option>
                    <option value="song4" data-url="https://raw.githubusercontent.com/Asiandra/comfort-characters/main/Music/Greed.mp3" data-artist="Marino" data-title="Greed">Greed</option>
                    <option value="song5" data-url="https://raw.githubusercontent.com/Asiandra/comfort-characters/main/Music/hideaway.mp3" data-artist="Marino" data-title="hideaway">hideaway</option>
                    <option value="song6" data-url="https://raw.githubusercontent.com/Asiandra/comfort-characters/main/Music/Lust.mp3" data-artist="Marino" data-title="Lust">Lust</option>
                    <option value="song7" data-url="https://raw.githubusercontent.com/Asiandra/comfort-characters/main/Music/c00lkidd_1%20(feat.%20ilyhiryu).mp3" data-artist="77yolan" data-title="c00lkidd_1 (feat. ilyhiryu)">c00lkidd_1 (feat. ilyhiryu)</option>
                    <option value="song8" data-url="https://raw.githubusercontent.com/Asiandra/comfort-characters/main/Music/Monika's%20Lullaby.mp3" data-artist="Monika After Story" data-title="Monika's Lullaby">Monika's Lullaby</option>
                </select>
                </div>

                <div class="flex items-center gap-2 px-1">
                    <span class="text-[9px]">VOL</span>
                    <input type="range" class="volume-slider" min="0" max="1" step="0.01" value="0.5" oninput="setVolume(this.value)">
                </div>
            </div>
            <audio id="main-audio" preload="auto" crossorigin="anonymous"></audio>
        </div>

        <!-- MY COMPUTER -->
        <div id="win-mycomputer" class="window window-border hidden opening animating" style="top: 50px; left: 50px; width: 400px; height: 300px;" onmousedown="focusWin('win-mycomputer')">
            <div class="title-bar" onmousedown="dragWindow(event, 'win-mycomputer')" ontouchstart="dragWindow(event, 'win-mycomputer')">
                <div class="flex items-center gap-1 min-w-0 flex-1">
                    <img src="https://i.postimg.cc/Y9VdbLqP/computer_explorer_5.png" class="w-4 h-4 flex-shrink-0"> 
                    <span class="win-title-text">My Computer</span>
                </div>
                <div class="flex gap-[2px] flex-shrink-0">
                    <button class="btn-border w-4 h-4 text-[10px] pb-1 font-bold" onclick="minimizeWin('win-mycomputer')">_</button>
                    <button class="btn-border w-4 h-4 text-[10px] font-bold" onclick="toggleMaximize('win-mycomputer')">‚ñ°</button>
                    <button class="btn-border w-4 h-4 text-[10px] font-bold" onclick="closeWin('win-mycomputer')">√ó</button>
                </div>
            </div>
            <div class="flex-1 bg-white m-1 retro-border-inset p-4 overflow-auto flex flex-wrap gap-4">
                <div class="flex flex-col items-center w-16 text-center cursor-pointer" onclick="window.open('https://github.com/Asiandra/comfort-characters')">
                    <img src="https://i.postimg.cc/Z567LxgF/keys-5.png" class="w-8 h-8 mb-1">
                    <span>The Code</span>
                </div>
                <div class="flex flex-col items-center w-16 text-center cursor-pointer" onclick="window.open('https://asiandra.github.io/Vibrant-Twilight/')">
                    <img src="https://i.postimg.cc/vZwTn94f/Favicon.png" class="w-8 h-8 mb-1">
                    <span>Vibrant Twilight</span>
                </div>
                <div class="flex flex-col items-center w-16 text-center cursor-pointer" onclick="window.open('https://kamisato-ajax.carrd.co/')">
                    <img src="https://i.postimg.cc/P5qtkxDF/Touya_Icon.png" class="w-8 h-8 mb-1">
                    <span>My Carrd</span>
                </div>
            </div>
            <div class="resizer" onmousedown="resizeWindow(event, 'win-mycomputer')" ontouchstart="resizeWindow(event, 'win-mycomputer')"></div>
        </div>

        <!-- README -->
        <div id="win-about" class="window window-border hidden opening animating" style="top: 80px; left: 80px; width: 350px; height: 280px;" onmousedown="focusWin('win-about')">
            <div class="title-bar" onmousedown="dragWindow(event, 'win-about')" ontouchstart="dragWindow(event, 'win-about')">
                <div class="flex items-center gap-1 min-w-0 flex-1">
                    <img src="https://i.postimg.cc/WbcnzvDq/notepad_5.png" class="w-4 h-4 flex-shrink-0"> 
                    <span class="win-title-text">Readme.txt</span>
                </div>
                <div class="flex gap-[2px] flex-shrink-0">
                    <button class="btn-border w-4 h-4 text-[10px] pb-1 font-bold" onclick="minimizeWin('win-about')">_</button>
                    <button class="btn-border w-4 h-4 text-[10px] font-bold" onclick="toggleMaximize('win-about')">‚ñ°</button>
                    <button class="btn-border w-4 h-4 text-[10px] font-bold" onclick="closeWin('win-about')">√ó</button>
                </div>
            </div>
            <div class="flex-1 bg-white m-1 retro-border-inset p-2 font-mono overflow-auto text-[10px]">
                KAVEH'S COMFORT CHARACTERS<br>
                ---------------------------<br>
                I'm never doing this again we're going simple next time<br>
                The music player is fully functional, go ahead and play around with it!<br>
                Currently, only Proect Sekai\Kamishiro  Rui has content, I'll work on the others soon!<br>
                ---------------------------<br>
                NOTES TO SELF<br>
                - Fandom file explorers and character windows cannot be dragged on mobile
            </div>
            <div class="resizer" onmousedown="resizeWindow(event, 'win-about')" ontouchstart="resizeWindow(event, 'win-about')"></div>
        </div>
    </div>

    <!-- DISPLAY PROPERTIES  -->
    <div id="win-display" class="window window-border hidden opening animating" style="top: 150px; left: 40px; width: 320px;" onmousedown="focusWin('win-display')">
        <div class="title-bar" onmousedown="dragWindow(event, 'win-display')" ontouchstart="dragWindow(event, 'win-display')">
                <div class="flex items-center gap-1 min-w-0 flex-1">
                    <img src="https://i.postimg.cc/BQb299x6/display_properties_5.png" class="w-4 h-4 flex-shrink-0">
                    <span class="win-title-text">Display Properties</span>
                </div>
            <div class="flex gap-[2px] flex-shrink-0">
                <button class="btn-border w-4 h-4 text-[10px] pb-1 font-bold" onclick="minimizeWin('win-display')">_</button>
                <button class="btn-border w-4 h-4 text-[10px] font-bold" onclick="closeWin('win-display')">√ó</button>
            </div>
        </div>
        <div class="p-4 bg-gray-200 space-y-4">
            <div class="flex flex-col items-center">
                <!-- PREVIEW -->
                <div class="w-48 h-32 retro-border-inset bg-teal-800 relative overflow-hidden flex items-center justify-center">
                    <div id="wallpaper-preview" class="w-full h-full bg-cover bg-center"></div>
                        <img src="https://i.postimg.cc/Y9VdbLqP/computer_explorer_5.png" class="absolute w-8 opacity-50">
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-[11px]">Background <u>W</u>allpaper:</label>
                    <div class="flex gap-2">
                    <select id="wallpaper-select" class="retro-select flex-1 h-6 min-w-0" onchange="previewWallpaper(this.value)">
                        <option value="none">Windows Default (Teal)</option>
                        <option value="https://i.postimg.cc/Pf38M3BC/A_Rush_Of_Excitement.png">A Rush of Excitement</option>
                        <option value="https://i.postimg.cc/3NR0TmDr/A_Step_Toward_One_s_Dream.png">A Step Toward One's Dream</option>
                        <option value="https://i.postimg.cc/cHJLgZ1h/Beacon_of_Truth.png">Beacon of Truth</option>
                        <option value="https://i.postimg.cc/5tgt2jJ1/Cutscene_beast_episode07_011.png">Beast Yeast 7-11 Cutscene</option>
                        <option value="https://i.postimg.cc/L5Y4DT19/Cutscene_beast_episode08_03.png">Beast Yeast 8-3 Cutscene</option>
                        <option value="https://i.postimg.cc/yNjN8WKk/Deceitful_Trio.png"> Deceitful Trio</option>
                        <option value="https://i.postimg.cc/fW20v269/My_Shackles_Are_The_Key.png">My Shackles Are The Key</option>
                        <option value="https://i.postimg.cc/63Qp2w6M/Smilk.png">Shadow Milk Cookie</option>
                        <option value="https://i.postimg.cc/xCd1JYjg/Spire_of_Shadows.png">Spire of Shadows</option>
                        <option value="https://i.postimg.cc/XNHygHT9/The_Reason_For_His_Words.png">The Reason For His Words</option>
                    </select>
                    <button class="btn-border h-6 px-2 w-20 text-[10px]" onclick="randomizeWallpaper()">üé≤ Random</button>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button class="btn-border h-6 w-20 font-bold" onclick="applyWallpaper()">OK</button>
                <button class="btn-border h-6 w-20" onclick="closeWin('win-display')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- WINDOWS STUFF -->
    <template id="folder-tpl">
        <div class="window window-border opening animating">
            <div class="title-bar">
                <div class="flex items-center gap-1 min-w-0 flex-1">
                    <img src="https://i.postimg.cc/Jhp6HdfF/directory_open_file_mydocs_4.png" class="w-4 h-4 flex-shrink-0"> 
                    <span class="win-title-text win-title">Folder</span>
                </div>
                <div class="flex gap-[2px] flex-shrink-0">
                    <button class="win-min btn-border w-4 h-4 text-[10px] pb-1 font-bold">_</button>
                    <button class="win-max btn-border w-4 h-4 text-[10px] font-bold">‚ñ°</button>
                    <button class="win-close btn-border w-4 h-4 text-[10px] font-bold">√ó</button>
                </div>
            </div>
            <div class="flex-1 bg-white m-1 retro-border-inset p-2 flex flex-wrap content-start gap-3 overflow-auto win-grid"></div>
            <div class="resizer"></div>
        </div>
    </template>

    <template id="profile-tpl">
        <div class="window window-border opening animating" style="width: 400px; height: 500px;">
            <div class="title-bar">
                <div class="flex items-center gap-1 min-w-0 flex-1">
                    <span class="win-icon flex-shrink-0"></span>
                    <span class="win-title-text win-title">Loading...</span>
                </div>
                <div class="flex gap-[2px] flex-shrink-0">
                    <button class="win-min btn-border w-4 h-4 text-[10px] pb-1 font-bold">_</button>
                    <button class="win-max btn-border w-4 h-4 text-[10px] font-bold">‚ñ°</button>
                    <button class="win-close btn-border w-4 h-4 text-[10px] font-bold">√ó</button>
                </div>
            </div>
            <div class="flex-1 bg-[#c0c0c0] p-1 flex flex-col overflow-hidden relative">
                <div class="loading-overlay absolute inset-0 flex flex-col items-center justify-center bg-gray-200 z-50">
                    <div class="loader"></div>
                    <p class="mt-2">Loading...</p>
                </div>
                <iframe class="profile-iframe retro-border-inset hidden" title="Character Profile"></iframe>
            </div>
            <div class="resizer"></div>
        </div>
    </template>

    <!-- Taskbar -->
    <div class="taskbar">
        <button class="btn-border h-6 px-1 flex items-center gap-1 font-bold" onclick="toggleStartMenu(event)">
            <img src="https://i.postimg.cc/SN9v1d9L/windows_0.png" class="w-4 h-4"> Start
        </button>
        <div class="mx-2 h-6 w-[2px] bg-gray-400 shadow-[1px_0_0_white]"></div>
        <div id="task-list" class="flex flex-1 gap-1 overflow-hidden h-full items-center"></div>
        <div class="ml-auto px-2 retro-border-inset h-6 flex items-center bg-gray-200">
            <span id="clock" class="font-mono text-[10px]">00:00 AM</span>
        </div>
    </div>

    <div id="start-menu" class="window window-border hidden fixed bottom-[30px] left-0.5 w-48 flex-row z-[100000]">
        <div class="bg-gray-500 w-8 flex items-end justify-center pb-2" style="background: linear-gradient(0deg, #000080, #1084d0);">
            <span class="text-white font-bold text-[14px] whitespace-nowrap" style="writing-mode: vertical-rl; transform: rotate(180deg);">Windows 98</span>
        </div>
        <div class="flex-1 bg-gray-200 py-1">
            <div class="px-4 py-2 hover:bg-blue-800 hover:text-white cursor-pointer" onclick="openWindow('win-mycomputer')"><img src="https://i.postimg.cc/Y9VdbLqP/computer_explorer_5.png" class="w-4 h-4 inline-block mr-2"> My Computer</div>
            <div class="px-4 py-2 hover:bg-blue-800 hover:text-white cursor-pointer" onclick="openWindow('win-music')"><img src="https://i.postimg.cc/7PGsb9KY/cd_audio_cd_a_4.png" class="w-4 h-4 inline-block mr-2"> CD Player</div>
            <div class="px-4 py-2 hover:bg-blue-800 hover:text-white cursor-pointer" onclick="openWindow('win-display')"><img src="https://i.postimg.cc/BQb299x6/display_properties_5.png" class="w-4 h-4 inline-block mr-2"> Display Properties</div>
            <div class="h-[1px] bg-gray-400 my-1 mx-2 shadow-[0_1px_0_white]"></div>
            <div class="px-4 py-2 hover:bg-blue-800 hover:text-white cursor-pointer" onclick="location.reload()">Sh<u>u</u>t Down...</div>
        </div>
    </div>

    <script>
        // Use jsDelivr as it bypasses GitHub's CORS restrictions for web browsers
        const GITHUB_CDN = "https://cdn.jsdelivr.net/gh/Asiandra/comfort-characters@main/Characters/";
        const GITHUB_RAW = "https://raw.githubusercontent.com/Asiandra/comfort-characters/main/Characters/";
        
        const characters = [
            { id: 'bsc', name: "Black Sapphire Cookie", media: "Cookie Run: Kingdom", icon: "https://i.postimg.cc/Tw3DpTgy/BSapphire_Icon.png", fileName: "black_sapphire.html" },
            { id: 'smc', name: "Shadow Milk Cookie", media: "Cookie Run: Kingdom", icon: "https://i.postimg.cc/LX81nmLg/SMilk_Icon.png", fileName: "shadow_milk.html" },
            { id: 'tr', name: "Truthless Recluse", media: "Cookie Run: Kingdom", icon: "https://i.postimg.cc/k5Dn7CnL/Truthless_Recluse_Icon.png", fileName: "truthless_recluse.html" },
            { id: 'chasca', name: "Chasca", media: "Hoyoverse", icon: "https://i.postimg.cc/ZYP07T0H/Chasca.png", fileName: "chasca.html" },
            { id: 'illuga', name: "Illuga", media: "Hoyoverse", icon: "https://i.postimg.cc/8zqCzZ2r/Illuga.png", fileName: "illuga.html" },
            { id: 'kaveh', name: "Kaveh", media: "Hoyoverse", icon: "https://i.postimg.cc/0jjj3SzJ/Kaveh_Icon.png", fileName: "kaveh.html" },
            { id: 'kuki', name: "Kuki Shinobu", media: "Hoyoverse", icon: "https://i.postimg.cc/FFb1W91x/Kuki_Shinobu.png", fileName: "kuki_shinobu.html" },
            { id: 'dan', name: "Dan Heng", media: "Hoyoverse", icon: "https://i.postimg.cc/7P1bsxbc/Dan_Heng_Icon.gif", fileName: "dan_heng.html" },
            { id: 'hl', name: "Hong Lu", media: "Limbus Company", icon: "https://i.postimg.cc/Tw3DpTgW/Hong_Lu_Icon.png", fileName: "hong_lu.html" },
            { id: 'ys', name: "Yi Sang", media: "Limbus Company", icon: "https://i.postimg.cc/RFP2PJ5v/Yi_Sang_Icon.png", fileName: "yi_sang.html" },
            { id: 'levi', name: "Leviathan", media: "Obey Me", icon: "https://i.postimg.cc/QNpCVX35/Leviathan.png", fileName: "leviathan.html" },
            { id: 'satan', name: "Satan", media: "Obey Me", icon: "https://i.postimg.cc/NG1FLgcm/Satan.png", fileName: "satan.html" },
            { id: 'belphie', name: "Belphegor", media: "Obey Me", icon: "https://i.postimg.cc/h49vhSBm/Belphegor.png", fileName: "belphegor.html" },
            { id: 'toya', name: "Aoyagi Toya", media: "Project Sekai", icon: "https://i.postimg.cc/kGSHc17y/Toya_Stamp.png", fileName: "aoyagi_toya.html" },
            { id: 'shiho', name: "Hinomori Shiho", media: "Project Sekai", icon: "https://i.postimg.cc/ZnNQc7Jj/Shiho_Stamp.png", fileName: "hinomori_shiho.html" },
            { id: 'rui', name: "Kamishiro Rui", media: "Project Sekai", icon: "https://i.postimg.cc/L5PWTCmD/Rui_Stamp.png", fileName: "kamishiro_rui.html" },
            { id: 'akt', name: "Shinonome Akito", media: "Project Sekai", icon: "https://i.postimg.cc/MHBLDPz9/Akito_Stamp.png", fileName: "shinonome_akito.html" },
            { id: 'ena', name: "Shinonome Ena", media: "Project Sekai", icon: "https://i.postimg.cc/VvthRGzB/Ena_Stamp.png", fileName: "shinonome_ena.html" },
            { id: 'tks', name: "Tenma Tsukasa", media: "Project Sekai", icon: "https://i.postimg.cc/prjSZGPq/Tsukasa_Stamp.png", fileName: "tenma_tsukasa.html" },
            { id: 'art', name: "Touno Arata", media: "Project Sekai", icon: "https://i.postimg.cc/VN3c1bZb/Arata_Tumblr.png", fileName: "touno_arata.html" },
            { id: 'smat', name: "Shadow Milk Aoyagi Touya", media: "MISC", icon: "https://i.postimg.cc/0Nr89v8T/SMilk_Touya_Icon.png", fileName: "smat.html" },
            { id: 'trkr', name: "Truthless Recluse Kamishiro Rui", media: "MISC", icon: "https://i.postimg.cc/SKjym4yw/TR_Rui_Icon.png", fileName: "trkr.html" }
        ];

        let zIndex = 200; 
        const registry = {};
        let musicTimer = null;
        const audio = document.getElementById('main-audio');

        function toggleStartMenu(e) { e.stopPropagation(); document.getElementById('start-menu')?.classList.toggle('hidden'); }
        function hideStartMenu() { document.getElementById('start-menu')?.classList.add('hidden'); }

        function deselectAllIcons(e) {
            const target = e.target;
            if (target.id === 'desktop' || target.id === 'icon-layer') {
                document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
            }
        }

        function handleIconInteraction(event, target, isFolder = false) {
            event.stopPropagation();
            const icon = event.currentTarget;
            document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
            icon.classList.add('selected');

            const rect = icon.getBoundingClientRect();
            const clientX = event.type.includes('touch') ? event.touches[0].clientX : event.clientX;
            const clientY = event.type.includes('touch') ? event.touches[0].clientY : event.clientY;
            const startX = clientX;
            const startY = clientY;
            const initialTop = rect.top;
            const initialLeft = rect.left;
            let hasMoved = false;

            const move = (ev) => {
                const curX = ev.type.includes('touch') ? ev.touches[0].clientX : ev.clientX;
                const curY = ev.type.includes('touch') ? ev.touches[0].clientY : ev.clientY;
                const dist = Math.sqrt(Math.pow(curX - startX, 2) + Math.pow(curY - startY, 2));
                if (dist > 5) {
                    hasMoved = true;
                    if (icon.parentElement.id === 'desktop-grid') {
                        icon.style.position = 'absolute';
                        icon.style.zIndex = '50';
                        document.getElementById('icon-layer').appendChild(icon);
                    }
                    icon.style.left = (initialLeft + (curX - startX)) + 'px';
                    icon.style.top = (initialTop + (curY - startY)) + 'px';
                }
            };

            const up = () => {
                document.removeEventListener('mousemove', move);
                document.removeEventListener('mouseup', up);
                document.removeEventListener('touchmove', move);
                document.removeEventListener('touchend', up);
                if (!hasMoved) {
                    if (isFolder) openFolder(target);
                    else openWindow(target);
                }
            };

            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', up);
            document.addEventListener('touchmove', move, {passive: false});
            document.addEventListener('touchend', up);
        }

        function openWindow(id) {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                requestAnimationFrame(() => {
                    el.classList.remove('opening');
                    el.classList.remove('minimized');
                });
                registry[id] = el;
            } else if (el.classList.contains('minimized')) {
                el.classList.remove('minimized');
            }
            focusWin(id);
            updateTaskbar();
        }

        function renderIcon(iconData, className = "w-8 h-8") {
            if (iconData.startsWith('http') || iconData.startsWith('./') || iconData.startsWith('data:')) {
                return `<img src="${iconData}" class="${className} object-contain pointer-events-none">`;
            }
            return `<div class="${className} flex items-center justify-center pointer-events-none">${iconData}</div>`;
        }

        function openFolder(type) {
            const id = 'folder-' + type.replace(/[^a-zA-Z]/g, '').toLowerCase();
            if (registry[id]) { 
                if (registry[id].classList.contains('minimized')) registry[id].classList.remove('minimized');
                focusWin(id); 
                return; 
            }
            const tpl = document.getElementById('folder-tpl').content.cloneNode(true);
            const win = tpl.querySelector('.window');
            win.id = id; win.style.top = '100px'; win.style.left = '100px'; win.style.width = '300px'; win.style.height = '240px';
            win.querySelector('.win-title').innerText = type;
            win.querySelector('.win-close').onclick = () => closeWin(id);
            win.querySelector('.win-min').onclick = () => minimizeWin(id);
            win.querySelector('.win-max').onclick = () => toggleMaximize(id);
            win.querySelector('.resizer').onmousedown = (e) => resizeWindow(e, id);
            win.onmousedown = () => focusWin(id);
            win.querySelector('.title-bar').onmousedown = (e) => dragWindow(e, id);

            const grid = win.querySelector('.win-grid');
            characters.filter(c => c.media === type).forEach(c => {
                const item = document.createElement('div');
                item.className = 'flex flex-col items-center w-16 p-1 cursor-pointer hover:bg-blue-800 hover:text-white rounded text-center';
                item.innerHTML = `${renderIcon(c.icon, "w-8 h-8")}<span class="text-[10px] w-full mt-1 leading-tight break-words">${c.name}</span>`;
                item.onclick = (e) => { e.stopPropagation(); openProfile(c); };
                grid.appendChild(item);
            });
            document.getElementById('desktop').appendChild(win);
            registry[id] = win;
            requestAnimationFrame(() => win.classList.remove('opening'));
            focusWin(id);
            updateTaskbar();
        }

        async function openProfile(char) {
            const id = 'profile-' + char.id;
            if (registry[id]) { openWindow(id); return; }

            const tpl = document.getElementById('profile-tpl').content.cloneNode(true);
            const win = tpl.querySelector('.window');
            win.id = id; win.style.top = '40px'; win.style.left = '120px';
            win.querySelector('.win-title').innerText = char.name;
            win.querySelector('.win-icon').innerHTML = `<img src="${char.icon}" class="w-4 h-4">`;
            win.querySelector('.win-close').onclick = () => closeWin(id);
            win.querySelector('.win-min').onclick = () => minimizeWin(id);
            win.querySelector('.win-max').onclick = () => toggleMaximize(id);
            win.querySelector('.title-bar').onmousedown = (e) => dragWindow(e, id);
            win.querySelector('.resizer').onmousedown = (e) => resizeWindow(e, id);

            const iframe = win.querySelector('.profile-iframe');
            const loader = win.querySelector('.loading-overlay');
            document.getElementById('desktop').appendChild(win);
            registry[id] = win;
            win.classList.remove('opening');
            focusWin(id);

            try {
                // FIXED: Use char.fileName because char.file was undefined
                const fileToLoad = char.fileName || char.file;
                if (!fileToLoad) throw new Error("No file path defined for this character.");

                // Helper to try fetching a specific URL
                async function tryFetch(url) {
                    try {
                        const response = await fetch(url, { cache: 'no-cache' });
                        if (!response.ok) return null;
                        return await response.text();
                    } catch (e) {
                        return null;
                    }
                }

                // Try CDN first (reliable), then Raw GitHub (backup)
                let htmlCode = await tryFetch(GITHUB_CDN + fileToLoad);
                if (!htmlCode) {
                    htmlCode = await tryFetch(GITHUB_RAW + fileToLoad);
                }

                if (!htmlCode) throw new Error("Could not reach database file.");
                
                const baseTag = `<base target="_blank">`;
                if (htmlCode.includes('<head>')) {
                    htmlCode = htmlCode.replace('<head>', `<head>${baseTag}`);
                } else {
                    htmlCode = baseTag + htmlCode;
                }

                iframe.srcdoc = htmlCode;
                iframe.onload = () => { 
                    loader.classList.add('hidden'); 
                    iframe.classList.remove('hidden'); 
                };
            } catch (err) {
                loader.innerHTML = `<p class="text-red-600 p-4 text-center">Connection Error:<br>${err.message}</p>`;
            }
        }

        function focusWin(id) {
            Object.values(registry).forEach(w => w.classList.remove('active-win'));
            const win = registry[id];
            if (!win) return;
            zIndex++; win.style.zIndex = zIndex;
            win.classList.add('active-win');
            updateTaskbar();
        }

        function minimizeWin(id) { registry[id].classList.add('minimized'); updateTaskbar(); }

        function closeWin(id) {
            const el = registry[id];
            el.classList.add('opening');
            setTimeout(() => {
                if (id.startsWith('folder-') || id.startsWith('profile-')) el.remove();
                else el.classList.add('hidden');
                delete registry[id];
                updateTaskbar();
            }, 200);
        }

        function toggleMaximize(id) {
            if (id === 'win-music') return;
            const win = registry[id];
            if (win) win.classList.toggle('maximized');
        }

        function dragWindow(e, id) {
            const win = registry[id];
            if (!win || win.classList.contains('maximized')) return;
            focusWin(id);
            win.classList.remove('animating'); 
            
            const startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const ox = startX - win.offsetLeft;
            const oy = startY - win.offsetTop;

            const move = (ev) => {
                const curX = ev.type.includes('touch') ? ev.touches[0].clientX : ev.clientX;
                const curY = ev.type.includes('touch') ? ev.touches[0].clientY : ev.clientY;
                win.style.left = (curX - ox) + 'px';
                win.style.top = (curY - oy) + 'px';
            };

            const up = () => {
                win.classList.add('animating');
                document.removeEventListener('mousemove', move);
                document.removeEventListener('mouseup', up);
                document.removeEventListener('touchmove', move);
                document.removeEventListener('touchend', up);
            };

            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', up);
            document.addEventListener('touchmove', move, { passive: false });
            document.addEventListener('touchend', up);
        }

        function resizeWindow(e, id) {
            e.stopPropagation();
            const win = registry[id];
            win.classList.remove('animating');
            const startW = win.offsetWidth;
            const startH = win.offsetHeight;
            const startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

            const move = (ev) => {
                const curX = ev.type.includes('touch') ? ev.touches[0].clientX : ev.clientX;
                const curY = ev.type.includes('touch') ? ev.touches[0].clientY : ev.clientY;
                win.style.width = Math.max(200, startW + (curX - startX)) + 'px';
                win.style.height = Math.max(150, startH + (curY - startY)) + 'px';
            };

            const up = () => {
                win.classList.add('animating');
                document.removeEventListener('mousemove', move);
                document.removeEventListener('mouseup', up);
                document.removeEventListener('touchmove', move);
                document.removeEventListener('touchend', up);
            };

            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', up);
            document.addEventListener('touchmove', move, { passive: false });
            document.addEventListener('touchend', up);
        }

        function updateTaskbar() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            Object.entries(registry).forEach(([id, win]) => {
                if (win.classList.contains('hidden')) return;
                const isActive = win.classList.contains('active-win');
                const titleText = win.querySelector('.win-title-text').innerText;
                let iconHtml = '';
                const titleIconSpan = win.querySelector('.win-icon');
                if (titleIconSpan && titleIconSpan.innerHTML.trim() !== "") {
                    iconHtml = titleIconSpan.innerHTML.replace('w-4 h-4', 'w-3 h-3').replace('text-xs', 'text-[10px]');
                } else {
                    const iconImg = win.querySelector('.win-icon-img');
                    if (iconImg) {
                        iconHtml = `<img src="${iconImg.src}" class="w-3 h-3">`;
                    } else if (win.querySelector('.title-bar img')) {
                        iconHtml = `<img src="${win.querySelector('.title-bar img').src}" class="w-3 h-3">`;
                    } else {
                        iconHtml = `<span>üìÅ</span>`;
                    }
                }
                
                const btn = document.createElement('button');
                btn.className = `task-btn ${isActive ? 'active-task' : ''}`;
                btn.innerHTML = `<div class="flex items-center justify-center w-4 h-4">${iconHtml}</div><span class="truncate ml-1">${titleText}</span>`;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    if (win.classList.contains('minimized')) { win.classList.remove('minimized'); focusWin(id); }
                    else if (isActive) minimizeWin(id); 
                    else focusWin(id);
                };
                list.appendChild(btn);
            });
        }

        // CD PLAYER
        function setVolume(v) { audio.volume = v; }
        
        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return "00:00";
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function changeTrack() {
            const select = document.getElementById('cd-track-select');
            const selected = select.options[select.selectedIndex];
            if (!selected || selected.value === 'none') return;
            document.getElementById('cd-artist').innerText = selected.getAttribute('data-artist');
            document.getElementById('cd-title').innerText = selected.getAttribute('data-title');
            audio.src = selected.getAttribute('data-url');
            playAudio();
            updateTrackStatus();
        }

        function updateTrackStatus() {
            const select = document.getElementById('cd-track-select');
            const trackCountEl = document.getElementById('cd-track-count');
            if (trackCountEl) {
                trackCountEl.innerText = `Track ${select.selectedIndex}/${select.options.length - 1}`;
            }
        }

        function playAudio() {
            if (!audio.src || audio.src === window.location.href || audio.src === "") {
                const select = document.getElementById('cd-track-select');
                if (select.selectedIndex <= 0 && select.options.length > 1) select.selectedIndex = 1;
                const selected = select.options[select.selectedIndex];
                if (selected && selected.value !== 'none') {
                    audio.src = selected.getAttribute('data-url');
                    document.getElementById('cd-artist').innerText = selected.getAttribute('data-artist');
                    document.getElementById('cd-title').innerText = selected.getAttribute('data-title');
                } else return;
            }
            
            audio.play().then(() => {
                document.getElementById('cd-play-indicator').style.opacity = '1';
                document.getElementById('cd-error').classList.add('hidden');
                startCDTimer();
                updateTrackStatus();
            }).catch((err) => {
                console.error("Playback failed:", err);
                document.getElementById('cd-error').classList.remove('hidden');
            });
        }

        function pauseAudio() { audio.pause(); document.getElementById('cd-play-indicator').style.opacity = '0'; }
        function stopAudio() { audio.pause(); audio.currentTime = 0; pauseAudio(); updateTimeDisplay(); }

        function nextTrack() {
            const select = document.getElementById('cd-track-select');
            select.selectedIndex = (select.selectedIndex % (select.options.length - 1)) + 1;
            changeTrack();
        }

        function prevTrack() {
            const select = document.getElementById('cd-track-select');
            select.selectedIndex = select.selectedIndex <= 1 ? select.options.length - 1 : select.selectedIndex - 1;
            changeTrack();
        }

        function startCDTimer() { if (!musicTimer) musicTimer = setInterval(updateTimeDisplay, 500); }
        function stopCDTimer() { clearInterval(musicTimer); musicTimer = null; }

        function updateTimeDisplay() {
            const select = document.getElementById('cd-track-select');
            const trackStr = select.selectedIndex.toString().padStart(2, '0');
            document.getElementById('cd-time').innerText = `[${trackStr}] ${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
        }

        audio.onended = () => nextTrack();
        
        setInterval(() => { 
            const d = new Date(); 
            document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); 
        }, 1000);

        window.onload = () => {
            const select = document.getElementById('cd-track-select');
            if (select && select.options.length > 1) {
                const first = select.options[1];
                document.getElementById('cd-artist').innerText = first.getAttribute('data-artist');
                document.getElementById('cd-title').innerText = first.getAttribute('data-title');
            }
            
            updateTrackStatus();
            openWindow('win-music');
            openWindow('win-about');
        };

        // WALLPAPER
        function previewWallpaper(url) {
            const preview = document.getElementById('wallpaper-preview');
            preview.style.backgroundImage = url === 'none' ? 'none' : `url('${url}')`;
            preview.style.backgroundSize = "cover";
        }

        function applyWallpaper() {
            const url = document.getElementById('wallpaper-select').value;
            if (url === 'none') {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = "var(--bg-teal)";
            } else {
                document.body.style.backgroundImage = `url('${url}')`;
                document.body.style.backgroundSize = "cover";
                document.body.style.backgroundRepeat = "no-repeat";
                document.body.style.backgroundAttachment = "fixed";
                document.body.style.backgroundPosition = "center center";
            }
            closeWin('win-display');
        }

        function randomizeWallpaper() {
            const select = document.getElementById('wallpaper-select');
            const opts = Array.from(select.options).filter(o => o.value !== 'none');
            const rand = opts[Math.floor(Math.random() * opts.length)];
            select.value = rand.value;
            previewWallpaper(rand.value);
            applyWallpaper();
        }
    </script>
</body>
</html>
